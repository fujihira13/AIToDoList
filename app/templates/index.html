<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>アイゼンハワーボード</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header class="page-header">
      <div>
        {% if copy.page_title %}
        <h1>{{ copy.page_title }}</h1>
        {% endif %}
      </div>
      <div class="header-actions">
        <button type="button" class="btn btn--primary" id="addTaskBtn">
          {{ copy.add_task }}
        </button>
        <button type="button" class="btn btn--secondary" id="addStaffBtn">
          メンバーを追加
        </button>
      </div>
    </header>

    <div class="tabs">
      <div class="tabs__header">
        <button type="button" class="tab-btn tab-btn--active" data-tab="board">
          ボード
        </button>
        <button type="button" class="tab-btn" data-tab="preview">
          プレビュー
        </button>
        <button type="button" class="tab-btn" data-tab="danger">
          デンジャーリスト
        </button>
        <button type="button" class="tab-btn" data-tab="members">
          メンバー
        </button>
        <button type="button" class="tab-btn" data-tab="completed">完了</button>
      </div>
      <div class="tabs__content">
        <div class="tab-panel tab-panel--active" id="boardTab">
          <main class="layout">
            <section class="board" id="board" aria-live="polite"></section>
          </main>
        </div>
        <div class="tab-panel" id="previewTab">
          <div class="preview-container">
            <div class="quadrant-overview" id="quadrantOverview"></div>
            <section class="preview-section">
              <h2 class="preview-section__title">職員別タスク分布</h2>
              <div class="staff-distribution" id="staffDistribution"></div>
            </section>
          </div>
        </div>
        <div class="tab-panel" id="dangerTab">
          <div class="danger-container">
            <div class="danger-gauge-container" id="dangerGauge"></div>
            <section class="danger-section">
              <h2 class="danger-section__title">スタッフ別危険度</h2>
              <div class="danger-staff-list" id="dangerStaffList"></div>
            </section>
            <section class="danger-section">
              <h2 class="danger-section__title">重要かつ緊急のタスク一覧</h2>
              <div class="danger-list" id="dangerList"></div>
            </section>
          </div>
        </div>
        <div class="tab-panel" id="membersTab">
          <div class="members-container">
            <section class="members-section">
              <div class="staff-panel__header">
                <h2>{{ copy.staff_title }}</h2>
              </div>
              <div class="staff-filter">
                <label for="staffFilter">名前で検索:</label>
                <input
                  type="text"
                  id="staffFilter"
                  class="staff-filter__input"
                  placeholder="メンバー名を入力してください"
                />
              </div>
              <div class="staff-sort">
                <label for="staffSortOrder">並び順:</label>
                <select id="staffSortOrder" class="staff-sort__select">
                  <option value="department-asc">職種（昇順）</option>
                  <option value="department-desc">職種（降順）</option>
                </select>
              </div>
              <div id="staffList" class="staff-list"></div>
            </section>
          </div>
        </div>
        <div class="tab-panel" id="completedTab">
          <div class="completed-container">
            <section class="completed-section">
              <div class="completed-panel__header">
                <h2>完了したタスク</h2>
              </div>
              <div class="completed-sort">
                <label for="completedSortOrder">並び順:</label>
                <select id="completedSortOrder" class="completed-sort__select">
                  <option value="date-asc">日付（昇順）</option>
                  <option value="date-desc">日付（降順）</option>
                  <option value="priority-asc">優先度（昇順）</option>
                  <option value="priority-desc">優先度（降順）</option>
                </select>
              </div>
              <div id="completedList" class="completed-list"></div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <dialog id="taskDialog" class="modal">
      <form id="taskForm" method="dialog">
        <header class="modal__header">
          <div>
            <h2
              id="taskFormTitle"
              data-create-label="{{ copy.form_create }}"
              data-edit-label="{{ copy.form_edit }}"
            >
              {{ copy.form_create }}
            </h2>
          </div>
          <button
            type="button"
            class="btn btn--close"
            id="cancelTaskBtn"
            aria-label="閉じる"
          >
            ×
          </button>
        </header>
        <input type="hidden" name="task_id" id="task_id" />

        <div class="form-grid">
          <label class="form-field">
            <span>タイトル *</span>
            <input
              type="text"
              name="title"
              id="title"
              maxlength="80"
              required
              placeholder="タスクの名前を入力してください"
            />
          </label>

          <label class="form-field">
            <span>担当者 *</span>
            <select name="owner_id" id="owner_id" required>
              <option value="" disabled selected>-- 選択してください --</option>
              {% for person in staff %}
              <option value="{{ person.id }}">{{ person.name }}</option>
              {% endfor %}
            </select>
            <small id="ownerDept" class="helper-text"></small>
          </label>

          <label class="form-field">
            <span>ステータス</span>
            <select name="status" id="status">
              {% for option in status_options %}
              <option value="{{ option.value }}">{{ option.label }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="form-field">
            <span>優先度</span>
            <select name="priority" id="priority">
              {% for option in priority_options %}
              <option value="{{ option.value }}">{{ option.label }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="form-field">
            <span>重要度 *</span>
            <select name="quadrant" id="quadrant">
              {% for quadrant in [1, 2, 3, 4] %}
              <option value="{{ quadrant }}">
                {{ quadrant_labels[quadrant] }}
              </option>
              {% endfor %}
            </select>
          </label>

          <label class="form-field">
            <span>期限</span>
            <input type="date" name="due_date" id="due_date" />
          </label>

          <label class="form-field">
            <span>作成者</span>
            <input
              type="text"
              name="created_by"
              id="created_by"
              placeholder="タスクを作成した人の名前"
            />
          </label>
        </div>

        <label class="form-field">
          <span>詳細</span>
          <textarea
            name="description"
            id="description"
            rows="4"
            maxlength="500"
            placeholder="タスクの詳細な内容を入力してください"
          ></textarea>
        </label>

        <footer class="modal__footer">
          <span id="formStatus" class="form-status" role="status"></span>
          <div class="modal__actions">
            <button type="button" class="btn btn--danger" id="deleteTaskBtn">
              {{ copy.delete_task }}
            </button>
            <button type="submit" class="btn btn--primary">
              {{ copy.save_task }}
            </button>
          </div>
        </footer>
      </form>
    </dialog>

    <dialog id="staffDialog" class="modal">
      <form id="staffForm" method="dialog" enctype="multipart/form-data">
        <input type="hidden" name="staff_id" id="staff_id" />
        <header class="modal__header">
          <div>
            <h2 id="staffFormTitle">メンバーを追加</h2>
          </div>
          <button
            type="button"
            class="btn btn--close"
            id="cancelStaffBtn"
            aria-label="閉じる"
          >
            ×
          </button>
        </header>

        <div class="form-grid">
          <label class="form-field">
            <span>名前 *</span>
            <input
              type="text"
              name="staff_name"
              id="staff_name"
              maxlength="50"
              required
              placeholder="メンバーの名前を入力してください"
            />
          </label>

          <label class="form-field">
            <span>所属部署</span>
            <input
              type="text"
              name="department"
              id="staff_department"
              maxlength="50"
              placeholder="所属部署を入力してください"
            />
          </label>
        </div>

        <label class="form-field">
          <span>アバター画像</span>
          <input type="file" name="photo" id="staff_photo" accept="image/*" />
          <small class="helper-text">
            ※1枚の顔写真から、Gemini / Nano Banana Pro によって4種類の表情
            （怒っている／やる気に満ちあふれている／困っている／お茶を飲んでいる）が
            自動生成され、重要度×緊急度の象限ごとに表示されます。
            APIキーが未設定の場合は、アップロードした1枚の画像のみが使用されます。
          </small>
        </label>

        <footer class="modal__footer">
          <span id="staffFormStatus" class="form-status" role="status"></span>
          <div class="modal__actions">
            <button
              type="button"
              class="btn btn--danger"
              id="deleteStaffBtn"
              style="display: none"
            >
              削除
            </button>
            <button type="submit" class="btn btn--primary" id="submitStaffBtn">
              追加
            </button>
          </div>
        </footer>
      </form>
    </dialog>

    <dialog id="confirmDialog" class="modal modal--confirm">
      <header class="modal__header">
        <div></div>
        <button
          type="button"
          class="btn btn--close"
          id="confirmCloseBtn"
          aria-label="閉じる"
        >
          ×
        </button>
      </header>
      <div class="modal__body">
        <p id="confirmMessage">{{ copy.confirm_delete }}</p>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn btn--danger" id="confirmDeleteBtn">
          {{ copy.confirm }}
        </button>
        <button type="button" class="btn btn--ghost" id="confirmCancelBtn">
          {{ copy.cancel }}
        </button>
      </div>
    </dialog>

    <!-- Gemini テスト用の簡易UI -->
    <section class="gemini-test" style="margin: 2rem;">
      <h2>Gemini 画像テスト</h2>
      <p>
        API キーやモデルの設定が正しく動作しているかを確認するためのテストです。
        下のプロンプトを編集して「テスト画像を生成」を押すと、1枚だけ画像を生成します。
      </p>
      <label class="form-field">
        <span>画像プロンプト</span>
        <input
          type="text"
          id="geminiTestPrompt"
          maxlength="300"
          placeholder="例: コスプレしたバナナの画像を生成してください。"
        />
      </label>
      <div style="margin-top: 0.5rem;">
        <button type="button" class="btn btn--secondary" id="geminiTestBtn">
          テスト画像を生成
        </button>
      </div>
      <div id="geminiTestResult" class="gemini-test__result" style="margin-top: 1rem;"></div>
    </section>

    <footer class="page-footer" style="display: none"></footer>

    <script id="initial-data" type="application/json">
      {{ initial_payload | tojson }}
    </script>
    <script type="module" src="/static/app.js"></script>
  </body>
</html>
